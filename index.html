<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Plantillas HTML - Signaturit</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            width: 95%;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 420px 1fr;
            gap: 0;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            min-height: 85vh;
        }

        .controls {
            background: #f8f9fa;
            padding: 25px;
            overflow-y: auto;
            max-height: 85vh;
            border-right: 1px solid #e9ecef;
        }

        .preview-section {
            display: flex;
            flex-direction: column;
            background: white;
        }

        .preview-toolbar {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            flex-wrap: wrap;
            align-items: center;
        }

        .toolbar-btn {
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .toolbar-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .toolbar-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .zoom-control {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 6px;
        }

        .zoom-control input {
            width: 80px;
            border: none;
            background: transparent;
        }

        .preview {
            padding: 30px;
            background: white;
            overflow-y: auto;
            flex: 1;
            position: relative;
            max-height: 85vh;
        }

        .preview.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
            max-height: 100vh;
            background: white;
        }

        .fullscreen-close {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .fullscreen-close:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .fullscreen-close.show {
            display: flex;
        }

        .preview.mobile-view .preview-frame {
            max-width: 375px;
            margin: 0 auto;
            border: 3px solid #333;
            border-radius: 30px;
            padding: 20px 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            background: white;
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 26px;
            font-weight: 700;
        }

        h2 {
            color: #495057;
            margin: 20px 0 12px 0;
            font-size: 15px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .subtitle {
            color: #6c757d;
            margin-bottom: 20px;
            font-size: 13px;
            line-height: 1.5;
        }

        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 500;
            font-size: 14px;
        }

        input[type="text"],
        input[type="url"],
        input[type="number"],
        textarea,
        input[type="color"] {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="url"]:focus,
        input[type="number"]:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        input[type="number"]::placeholder {
            font-size: 11px;
            color: #adb5bd;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .color-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="color"] {
            width: 60px;
            height: 40px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
        }

        .color-value {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 13px;
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        button {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .preview-title {
            color: #495057;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
        }

        .preview-frame {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            background: #f8f9fa;
            transform-origin: top center;
            transition: transform 0.3s;
            width: 100%;
            overflow: auto;
        }

        .code-view {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            max-height: 70vh;
            display: none;
        }

        .code-view.active {
            display: block;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-size: 13px;
            color: #495057;
        }

        .info-box code {
            background: #fff3cd;
            color: #856404;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .variable-tag {
            display: inline-block;
            background: #fff3cd;
            color: #856404;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin: 2px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .variable-tag:hover {
            background: #ffc107;
            transform: scale(1.05);
        }

        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10000;
            animation: slideIn 0.3s, slideOut 0.3s 2.7s;
            display: none;
        }

        .toast.show {
            display: block;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            margin: 0;
            color: #667eea;
        }

        .close-modal {
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            color: #000;
        }

        .variables-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            min-height: 60px;
        }

        .variable-pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            font-weight: 500;
            position: relative;
        }

        .variable-pill:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .variable-pill:active {
            transform: translateY(0);
        }

        .variable-pill .delete-var {
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: background 0.2s;
        }

        .variable-pill .delete-var:hover {
            background: rgba(255,255,255,0.5);
        }

        .variable-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background: #1a1a1a;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 1000;
            max-width: 300px;
            white-space: normal;
            text-align: center;
        }

        .variable-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #1a1a1a;
        }

        .variable-pill:hover .variable-tooltip {
            opacity: 1;
        }

        .add-variable-form {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .add-variable-form input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
        }

        .add-variable-form input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-add {
            background: #28a745;
            color: white;
        }

        .btn-add:hover {
            background: #218838;
        }

        .btn-open-modal {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            width: 100%;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-open-modal:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .variable-hint {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #856404;
        }

        .empty-state {
            text-align: center;
            color: #6c757d;
            padding: 20px;
            font-size: 14px;
        }

        .btn-logo {
            background: #ff6b6b;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .btn-logo:hover {
            background: #ee5a52;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        }

        .variables-inline {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            min-height: 60px;
            margin-bottom: 10px;
        }

        .variable-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
            font-family: 'Courier New', monospace;
        }

        .variable-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .variable-btn:active {
            transform: translateY(0);
        }

        .btn-manage-vars {
            background: #6c757d;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            width: 100%;
            transition: all 0.2s;
        }

        .btn-manage-vars:hover {
            background: #5a6268;
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
            }

            .controls, .preview {
                max-height: none;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <h1>üé® Generador de Emails</h1>
            <p class="subtitle">Personaliza tu plantilla de firma de Signaturit</p>

            <h2>üè∑Ô∏è Variables</h2>
            <div class="info-box">
                Incluye las <strong>14 variables oficiales de Signaturit</strong> + las tuyas personalizadas. Haz clic para gestionar e insertar donde quieras.
            </div>
            
            <button class="btn-open-modal" onclick="openVariableModal()">
                ‚ú® Gestionar Variables
                <span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 12px; font-size: 12px;" id="variableCount">14</span>
            </button>

            <h2>üìù Contenido del Email</h2>
            
            <div class="form-group">
                <label>URL del Logo</label>
                <div style="display: flex; gap: 10px;">
                    <input type="url" id="logoUrl" placeholder="https://ejemplo.com/logo.png" style="flex: 1;">
                    <button class="btn-logo" onclick="insertLogoVariable()">üñºÔ∏è Logo</button>
                </div>
            </div>

            <div class="form-group">
                <label>Ancho del Logo (px)</label>
                <input type="text" id="logoWidth" value="300">
            </div>

            <div class="form-group">
                <label>Contenido Completo del Email</label>
                <textarea id="emailContent" style="min-height: 300px;" placeholder="Escribe aqu√≠ el contenido de tu email...&#10;&#10;Ejemplo:&#10;Estimado/a {{signer_name}}, le hacemos llegar la documentaci√≥n:&#10;&#10;{{filename}}&#10;&#10;Para firmar, haga clic en: {{sign_button}}&#10;&#10;{{email_body}}"></textarea>
            </div>

            <div class="form-group">
                <label>Variables Disponibles (Haz clic para insertar)</label>
                <div class="variables-inline" id="variablesInline"></div>
                <button class="btn-manage-vars" onclick="openVariableModal()">
                    ‚öôÔ∏è Gestionar Variables
                </button>
            </div>

            <h2>üé® Colores</h2>

            <div class="form-group">
                <label>Color de Fondo Principal</label>
                <div class="color-input">
                    <input type="color" id="bgColor" value="#ffffff">
                    <input type="text" class="color-value" id="bgColorValue" value="#ffffff">
                </div>
            </div>

            <div class="form-group">
                <label>Color del Contenedor</label>
                <div class="color-input">
                    <input type="color" id="containerColor" value="#ffffff">
                    <input type="text" class="color-value" id="containerColorValue" value="#ffffff">
                </div>
            </div>

            <div class="form-group">
                <label>Color del Borde del Contenedor</label>
                <div class="color-input">
                    <input type="color" id="borderColor" value="#cccccc">
                    <input type="text" class="color-value" id="borderColorValue" value="#cccccc">
                </div>
            </div>

            <div class="form-group">
                <label>Color del Texto</label>
                <div class="color-input">
                    <input type="color" id="textColor" value="#153643">
                    <input type="text" class="color-value" id="textColorValue" value="#153643">
                </div>
            </div>

            <h2>üîò Estilo del Bot√≥n</h2>

            <div class="form-group">
                <label>Color de Fondo del Bot√≥n</label>
                <div class="color-input">
                    <input type="color" id="buttonColor" value="#070707">
                    <input type="text" class="color-value" id="buttonColorValue" value="#070707">
                </div>
            </div>

            <div class="form-group">
                <label>Color del Texto del Bot√≥n</label>
                <div class="color-input">
                    <input type="color" id="buttonTextColor" value="#ffffff">
                    <input type="text" class="color-value" id="buttonTextColorValue" value="#ffffff">
                </div>
            </div>

            <div class="form-group">
                <label>Color del Borde del Bot√≥n</label>
                <div class="color-input">
                    <input type="color" id="buttonBorderColor" value="#070707">
                    <input type="text" class="color-value" id="buttonBorderColorValue" value="#070707">
                </div>
            </div>

            <div class="form-group">
                <label>Grosor del Borde (px)</label>
                <input type="number" id="buttonBorderWidth" value="0" min="0" max="10">
            </div>

            <div class="form-group">
                <label>Radio del Borde (px)</label>
                <input type="number" id="buttonBorderRadius" value="20" min="0" max="50">
            </div>

            <div class="form-group">
                <label>Padding (Top, Right, Bottom, Left en px)</label>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                    <input type="number" id="buttonPaddingTop" value="15" min="0" max="50" placeholder="Top">
                    <input type="number" id="buttonPaddingRight" value="15" min="0" max="50" placeholder="Right">
                    <input type="number" id="buttonPaddingBottom" value="15" min="0" max="50" placeholder="Bottom">
                    <input type="number" id="buttonPaddingLeft" value="15" min="0" max="50" placeholder="Left">
                </div>
            </div>

            <div class="form-group">
                <label>Margin (Top, Right, Bottom, Left en px)</label>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                    <input type="number" id="buttonMarginTop" value="10" min="0" max="50" placeholder="Top">
                    <input type="number" id="buttonMarginRight" value="0" min="0" max="50" placeholder="Right">
                    <input type="number" id="buttonMarginBottom" value="10" min="0" max="50" placeholder="Bottom">
                    <input type="number" id="buttonMarginLeft" value="0" min="0" max="50" placeholder="Left">
                </div>
            </div>

            <div class="form-group">
                <label>Ancho del Bot√≥n (px)</label>
                <input type="number" id="buttonWidth" value="200" min="100" max="400">
            </div>

            <div class="button-group">
                <button class="btn-primary" onclick="downloadHTML()">‚¨áÔ∏è Descargar</button>
                <button class="btn-secondary" onclick="resetToDefault()">üîÑ Reset</button>
            </div>
        </div>

        <div class="preview-section">
            <div class="preview-toolbar">
                <button class="toolbar-btn" onclick="toggleView()" id="viewToggle">
                    üì± Vista Mobile
                </button>
                <button class="toolbar-btn" onclick="toggleFullscreen()" id="fullscreenBtn">
                    ‚õ∂ Pantalla Completa
                </button>
                <button class="toolbar-btn" onclick="toggleCodeView()" id="codeViewBtn">
                    üëÅÔ∏è Ver C√≥digo
                </button>
                <button class="toolbar-btn" onclick="copyToClipboard()">
                    üìã Copiar HTML
                </button>
                <button class="toolbar-btn" onclick="updatePreview()">
                    üîÑ Refrescar
                </button>
                <div class="zoom-control">
                    üîç
                    <input type="range" id="zoomSlider" min="50" max="150" value="100" oninput="updateZoom(this.value)">
                    <span id="zoomValue">100%</span>
                </div>
            </div>

            <div class="preview" id="previewContainer">
                <div class="preview-frame" id="previewFrame"></div>
                <pre class="code-view" id="codeView"></pre>
            </div>
            <button class="fullscreen-close" id="fullscreenCloseBtn" onclick="toggleFullscreen()">‚úï</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Modal de Variables -->
    <div class="modal" id="variableModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üè∑Ô∏è Gestionar Variables</h2>
                <button class="close-modal" onclick="closeVariableModal()">&times;</button>
            </div>

            <div class="variable-hint">
                üí° <strong>Tip:</strong> Haz clic en una variable para insertarla. Pasa el mouse sobre cada una para ver su descripci√≥n.
            </div>

            <div class="variables-grid" id="variablesGrid">
                <!-- Las variables se renderizan aqu√≠ -->
            </div>

            <div class="add-variable-form">
                <input type="text" id="newVariableName" placeholder="nombre_variable" onkeypress="handleVariableKeyPress(event)">
                <button class="btn-small btn-add" onclick="addVariableFromModal()">‚ûï Agregar</button>
            </div>
        </div>
    </div>

    <script>
        // Variables oficiales de Signaturit
        let variables = [
            'sender_email',
            'sign_button',
            'validate_button',
            'signer_name',
            'signer_email',
            'filename',
            'logo',
            'remaining_time',
            'email_button',
            'email_body',
            'code',
            'reason',
            'dashboard_button',
            'signers'
        ];

        // Descripciones de variables oficiales
        const variableDescriptions = {
            'sender_email': 'Email del remitente',
            'sign_button': 'Bot√≥n de Signaturit (solo signatures_request y pending_sign)',
            'validate_button': 'Bot√≥n de validar documento (solo validation_request)',
            'signer_name': 'Nombre del firmante',
            'signer_email': 'Email del firmante',
            'filename': 'Nombre del archivo (o archivos)',
            'logo': 'Logo actual',
            'remaining_time': 'Fecha de expiraci√≥n del documento (solo pending_sign)',
            'email_button': 'Bot√≥n de Signaturit (solo emails_request)',
            'email_body': 'Texto del par√°metro body (solo signatures_request)',
            'code': 'C√≥digo SMS (solo sms_verify y sms_validate)',
            'reason': 'Raz√≥n por la que se rechaz√≥ la firma (solo document_declined)',
            'dashboard_button': 'Bot√≥n para ver detalles en dashboard (solo document_declined)',
            'signers': 'Nombre y email del firmante en formato NOMBRE - EMAIL (solo signed_document)'
        };

        // Valores por defecto de la plantilla
        const defaults = {
            logoUrl: 'https://upload.wikimedia.org/wikipedia/commons/1/1e/Wikipedia-logo-v2-es.svg',
            logoWidth: '300',
            emailContent: 'Estimado/a {{signer_name}}, le hacemos llegar la siguiente documentaci√≥n para firmar:\n\n{{filename}}\n\nPara proceder con la revisi√≥n de la documentaci√≥n presione el siguiente bot√≥n:\n\n{{sign_button}}\n\n{{email_body}}',
            bgColor: '#ffffff',
            containerColor: '#ffffff',
            borderColor: '#cccccc',
            buttonColor: '#070707',
            buttonTextColor: '#ffffff',
            buttonBorderColor: '#070707',
            buttonBorderWidth: '0',
            buttonBorderRadius: '20',
            buttonPaddingTop: '15',
            buttonPaddingRight: '15',
            buttonPaddingBottom: '15',
            buttonPaddingLeft: '15',
            buttonMarginTop: '10',
            buttonMarginRight: '0',
            buttonMarginBottom: '10',
            buttonMarginLeft: '0',
            buttonWidth: '200',
            textColor: '#153643'
        };

        let currentZoom = 100;
        let isMobileView = false;
        let isFullscreen = false;
        let showCodeView = false;

        // Renderizar variables inline como botones
        function renderVariablesInline() {
            const container = document.getElementById('variablesInline');
            
            if (variables.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay variables disponibles</div>';
                return;
            }
            
            container.innerHTML = variables.map(varName => `
                <button class="variable-btn" onclick="insertVariableInline('${varName}')">{{${varName}}}</button>
            `).join('');
        }

        // Insertar variable desde los botones inline
        function insertVariableInline(varName) {
            const textarea = document.getElementById('emailContent');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const variable = `{{${varName}}}`;

            // Insertar la variable en la posici√≥n del cursor
            textarea.value = text.substring(0, start) + variable + text.substring(end);
            
            // Colocar el cursor despu√©s de la variable insertada
            const newPosition = start + variable.length;
            textarea.setSelectionRange(newPosition, newPosition);
            
            // Mantener el foco en el textarea
            textarea.focus();
            
            // Actualizar la previsualizaci√≥n
            updatePreview();
            
            showToast(`‚úì Variable {{${varName}}} insertada`);
        }

        // Insertar variable {{logo}}
        function insertLogoVariable() {
            insertVariableInline('logo');
        }

        // Renderizar lista de variables como pills clicables
        function renderVariables() {
            const container = document.getElementById('variablesGrid');
            
            if (variables.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay variables. Agrega una usando el campo de abajo.</div>';
                updateVariableCount();
                renderVariablesInline();
                return;
            }
            
            container.innerHTML = variables.map((varName, index) => {
                const description = variableDescriptions[varName] || 'Variable personalizada';
                return `
                    <div class="variable-pill" onclick="insertVariableAtCursor('${varName}')">
                        <span>{{${varName}}}</span>
                        <span class="delete-var" onclick="event.stopPropagation(); deleteVariable(${index})">√ó</span>
                        <div class="variable-tooltip">${description}</div>
                    </div>
                `;
            }).join('');
            
            updateVariableCount();
            renderVariablesInline();
        }

        // Actualizar contador de variables en el bot√≥n
        function updateVariableCount() {
            const btn = document.getElementById('variableCount');
            if (btn) {
                btn.textContent = variables.length;
            }
        }

        // Agregar variable desde el modal
        function addVariableFromModal() {
            const input = document.getElementById('newVariableName');
            const varName = input.value.trim();
            
            if (!varName) {
                showToast('‚ö†Ô∏è Ingresa un nombre de variable');
                return;
            }
            
            if (variables.includes(varName)) {
                showToast('‚ö†Ô∏è Esta variable ya existe');
                return;
            }
            
            variables.push(varName);
            renderVariables();
            input.value = '';
            showToast('‚úì Variable agregada');
        }

        // Manejar Enter en el input de nueva variable
        function handleVariableKeyPress(event) {
            if (event.key === 'Enter') {
                addVariableFromModal();
            }
        }

        // Abrir modal de variables
        function openVariableModal() {
            document.getElementById('variableModal').classList.add('show');
            renderVariables();
        }

        // Cerrar modal de variables
        function closeVariableModal() {
            document.getElementById('variableModal').classList.remove('show');
        }

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const modal = document.getElementById('variableModal');
            if (event.target === modal) {
                closeVariableModal();
            }
        }

        // Variables para tracking del cursor
        let lastFocusedTextarea = null;
        let lastCursorPosition = 0;

        // Insertar variable en la posici√≥n del cursor (desde modal)
        function insertVariableAtCursor(varName) {
            const textarea = document.getElementById('emailContent');
            const start = textarea.selectionStart || 0;
            const end = textarea.selectionEnd || 0;
            const text = textarea.value;
            const variable = `{{${varName}}}`;

            // Insertar la variable en la posici√≥n del cursor
            textarea.value = text.substring(0, start) + variable + text.substring(end);
            
            // Colocar el cursor despu√©s de la variable insertada
            const newPosition = start + variable.length;
            textarea.setSelectionRange(newPosition, newPosition);
            
            // Mantener el foco en el textarea
            textarea.focus();
            
            // Actualizar la previsualizaci√≥n
            updatePreview();
            
            showToast(`‚úì Variable {{${varName}}} insertada`);
            
            // No cerrar el modal para permitir insertar m√∫ltiples variables
        }

        // Eliminar variable
        function deleteVariable(index) {
            if (confirm(`¬øEliminar la variable {{${variables[index]}}}?`)) {
                variables.splice(index, 1);
                renderVariables();
                showToast('‚úì Variable eliminada');
            }
        }

        // Actualizar variable
        function updateVariable(index, value) {
            variables[index] = value;
            updateVariableCount();
        }

        // Sincronizar inputs de color
        function syncColorInputs() {
            const colorPairs = [
                ['bgColor', 'bgColorValue'],
                ['containerColor', 'containerColorValue'],
                ['borderColor', 'borderColorValue'],
                ['buttonColor', 'buttonColorValue'],
                ['buttonTextColor', 'buttonTextColorValue'],
                ['buttonBorderColor', 'buttonBorderColorValue'],
                ['textColor', 'textColorValue']
            ];

            colorPairs.forEach(([pickerId, valueId]) => {
                const picker = document.getElementById(pickerId);
                const value = document.getElementById(valueId);

                picker.addEventListener('input', (e) => {
                    value.value = e.target.value;
                    updatePreview();
                });

                value.addEventListener('input', (e) => {
                    if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                        picker.value = e.target.value;
                        updatePreview();
                    }
                });
            });
        }

        // Generar HTML (las variables quedan vac√≠as para que Signaturit las complete)
        function generateHTML() {
            const logoUrl = document.getElementById('logoUrl').value || defaults.logoUrl;
            const logoWidth = document.getElementById('logoWidth').value || defaults.logoWidth;
            const emailContent = document.getElementById('emailContent').value;
            const bgColor = document.getElementById('bgColor').value;
            const containerColor = document.getElementById('containerColor').value;
            const borderColor = document.getElementById('borderColor').value;
            const buttonColor = document.getElementById('buttonColor').value;
            const buttonTextColor = document.getElementById('buttonTextColor').value;
            const buttonBorderColor = document.getElementById('buttonBorderColor').value;
            const buttonBorderWidth = document.getElementById('buttonBorderWidth').value || '0';
            const buttonBorderRadius = document.getElementById('buttonBorderRadius').value || '20';
            const buttonPaddingTop = document.getElementById('buttonPaddingTop').value || '15';
            const buttonPaddingRight = document.getElementById('buttonPaddingRight').value || '15';
            const buttonPaddingBottom = document.getElementById('buttonPaddingBottom').value || '15';
            const buttonPaddingLeft = document.getElementById('buttonPaddingLeft').value || '15';
            const buttonMarginTop = document.getElementById('buttonMarginTop').value || '10';
            const buttonMarginRight = document.getElementById('buttonMarginRight').value || '0';
            const buttonMarginBottom = document.getElementById('buttonMarginBottom').value || '10';
            const buttonMarginLeft = document.getElementById('buttonMarginLeft').value || '0';
            const buttonWidth = document.getElementById('buttonWidth').value || '200';
            const textColor = document.getElementById('textColor').value;

            // Crear el HTML del bot√≥n estilizado
            const buttonBorderStyle = buttonBorderWidth > 0 ? `border:${buttonBorderWidth}px solid ${buttonBorderColor};` : '';
            const buttonPaddingStyle = `padding:${buttonPaddingTop}px ${buttonPaddingRight}px ${buttonPaddingBottom}px ${buttonPaddingLeft}px;`;
            const buttonMarginStyle = `margin:${buttonMarginTop}px ${buttonMarginRight}px ${buttonMarginBottom}px ${buttonMarginLeft}px;`;
            const buttonHTML = `<table class="miboton" align="center" style='width:${buttonWidth}px;background:${buttonColor};border-radius:${buttonBorderRadius}px;${buttonBorderStyle}${buttonMarginStyle}'>
\t\t\t\t\t\t\t\t\t\t\t<tr>
\t\t\t\t\t\t\t\t\t\t\t\t<td style='${buttonPaddingStyle}line-height:12px'>
\t\t\t\t\t\t\t\t\t\t\t\t\t<p style='text-align:center;margin:0;'>
\t\t\t\t\t\t\t\t\t\t\t\t\t\t<span class="mititulo" style='font-size:18px;font-family:"Arial";color:${buttonTextColor};'>{{sign_button}}</span>
\t\t\t\t\t\t\t\t\t\t\t\t\t</p>
\t\t\t\t\t\t\t\t\t\t\t\t</td>
\t\t\t\t\t\t\t\t\t\t\t</tr>
\t\t\t\t\t\t\t\t\t\t</table>`;

            // Convertir el contenido a p√°rrafos HTML y reemplazar {{sign_button}} con el HTML del bot√≥n
            const contentParagraphs = emailContent
                .split('\n')
                .filter(line => line.trim() !== '')
                .map(line => {
                    // Si la l√≠nea contiene {{sign_button}}, reemplazarla con el HTML del bot√≥n
                    if (line.includes('{{sign_button}}')) {
                        return line.replace('{{sign_button}}', buttonHTML);
                    }
                    return `\t\t\t\t\t\t\t\t\t\t<p style="margin:0 0 12px 0;font-size:16px;line-height:24px;font-family:'Helvetica Neue', Helvetica, Arial;">\n\t\t\t\t\t\t\t\t\t\t${line}</p>`;
                })
                .join('\n');

            return `<!DOCTYPE html>
<html lang="es" xmlns="http://www.w3.org/1999/xhtml" xmlns:o="urn:schemas-microsoft-com:office:office">
<head>
\t<meta charset="UTF-8">
\t<meta name="viewport" content="width=device-width,initial-scale=1">
\t<meta name="x-apple-disable-message-reformatting">
\t<title>Solicitud de Firma</title>
\t<!--[if mso]>
\t<noscript>
\t\t<xml>
\t\t\t<o:OfficeDocumentSettings>
\t\t\t\t<o:PixelsPerInch>96</o:PixelsPerInch>
\t\t\t</o:OfficeDocumentSettings>
\t\t</xml>
\t</noscript>
\t<![endif]-->
\t<style>
\t\ttable, td, div, h1, p {font-family: 'Helvetica Neue', Helvetica, Arial;}
\t</style>
</head>
<body style="margin:0;padding:0;background-color: ${bgColor};">
\t<table role="presentation" style="width:100%;border-collapse:collapse;border:0;border-spacing:0;margin:30px 0px;">
\t\t<tr>
\t\t\t<td align="center" style="padding:0;">
\t\t\t\t<table role="presentation" style="width:800px;border-collapse:collapse;border:1px solid ${borderColor};border-spacing:0;text-align:left;background:${containerColor}">
\t\t\t\t\t<tr>
\t\t\t\t\t\t<td align="center" style="padding:30px 0 20px 0;">
\t\t\t\t\t\t\t<img width="${logoWidth}px" height="auto" style="display:block;" alt="Logo" src="${logoUrl}">
\t\t\t\t\t\t</td>
\t\t\t\t\t</tr>
\t\t\t\t\t<tr>
\t\t\t\t\t\t<td style="padding:10px 25px 0px 25px;">
\t\t\t\t\t\t\t<table role="presentation" style="width:100%;border-collapse:collapse;border:0;border-spacing:0;">
\t\t\t\t\t\t\t\t<tr>
\t\t\t\t\t\t\t\t\t<td style="padding:0 0 25px 0;color:${textColor};">
${contentParagraphs}
\t\t\t\t\t\t\t\t\t</td>
\t\t\t\t\t\t\t\t</tr>
\t\t\t\t\t\t\t</table>
\t\t\t\t\t\t</td>
\t\t\t\t\t</tr>
\t\t\t\t</table>
\t\t\t</td>
\t\t</tr>
\t</table>
</body>
</html>`;
        }

        // Actualizar vista previa
        function updatePreview() {
            const html = generateHTML();
            document.getElementById('previewFrame').innerHTML = html;
            updateCodeView();
        }

        // Actualizar vista de c√≥digo
        function updateCodeView() {
            const html = generateHTML();
            document.getElementById('codeView').textContent = html;
        }

        // Controles de vista
        function toggleView() {
            isMobileView = !isMobileView;
            const preview = document.getElementById('previewContainer');
            const btn = document.getElementById('viewToggle');
            
            if (isMobileView) {
                preview.classList.add('mobile-view');
                btn.classList.add('active');
                btn.innerHTML = 'üíª Vista Desktop';
            } else {
                preview.classList.remove('mobile-view');
                btn.classList.remove('active');
                btn.innerHTML = 'üì± Vista Mobile';
            }
        }

        function toggleFullscreen() {
            isFullscreen = !isFullscreen;
            const preview = document.getElementById('previewContainer');
            const btn = document.getElementById('fullscreenBtn');
            const closeBtn = document.getElementById('fullscreenCloseBtn');
            
            if (isFullscreen) {
                preview.classList.add('fullscreen');
                btn.classList.add('active');
                btn.innerHTML = '‚õ∂ Salir Pantalla Completa';
                closeBtn.classList.add('show');
            } else {
                preview.classList.remove('fullscreen');
                btn.classList.remove('active');
                btn.innerHTML = '‚õ∂ Pantalla Completa';
                closeBtn.classList.remove('show');
            }
        }

        function toggleCodeView() {
            showCodeView = !showCodeView;
            const codeView = document.getElementById('codeView');
            const previewFrame = document.getElementById('previewFrame');
            const btn = document.getElementById('codeViewBtn');
            
            if (showCodeView) {
                codeView.classList.add('active');
                previewFrame.style.display = 'none';
                btn.classList.add('active');
                btn.innerHTML = 'üëÅÔ∏è Ver Preview';
            } else {
                codeView.classList.remove('active');
                previewFrame.style.display = 'block';
                btn.classList.remove('active');
                btn.innerHTML = 'üëÅÔ∏è Ver C√≥digo';
            }
        }

        function updateZoom(value) {
            currentZoom = value;
            document.getElementById('zoomValue').textContent = value + '%';
            document.getElementById('previewFrame').style.transform = `scale(${value / 100})`;
        }

        // Copiar al portapapeles
        async function copyToClipboard() {
            const html = generateHTML();
            try {
                await navigator.clipboard.writeText(html);
                showToast('‚úì HTML copiado al portapapeles');
            } catch (err) {
                showToast('‚úó Error al copiar');
            }
        }

        // Descargar HTML
        function downloadHTML() {
            const html = generateHTML();
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `signaturit-email-template-${Date.now()}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('‚úì HTML descargado');
        }

        // Reset
        function resetToDefault() {
            if (confirm('¬øEst√°s seguro de que quieres resetear todos los valores?')) {
                Object.keys(defaults).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = defaults[key];
                    }
                    const valueElement = document.getElementById(key + 'Value');
                    if (valueElement) {
                        valueElement.value = defaults[key];
                    }
                });
                
                // Resetear variables oficiales de Signaturit
                variables = [
                    'sender_email',
                    'sign_button',
                    'validate_button',
                    'signer_name',
                    'signer_email',
                    'filename',
                    'logo',
                    'remaining_time',
                    'email_button',
                    'email_body',
                    'code',
                    'reason',
                    'dashboard_button',
                    'signers'
                ];
                renderVariables();
                updatePreview();
                showToast('‚úì Valores reseteados');
            }
        }

        // Mostrar toast
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Event listeners
        document.querySelectorAll('input:not([type="range"]), textarea').forEach(element => {
            element.addEventListener('input', updatePreview);
        });

        // Inicializar
        syncColorInputs();
        renderVariables();
        resetToDefault();
    </script>
</body>
</html>